<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 40px 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 3em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .nav-buttons {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 30px;
      }

      .nav-btn {
        background: white;
        color: #667eea;
        padding: 15px 30px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .nav-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .stat-card h3 {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 3em;
        font-weight: bold;
        color: #667eea;
      }

      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
      }

      .chart-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .chart-card h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
      }

      .log-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .log-section h2 {
        color: #333;
        margin-bottom: 20px;
      }

      .log-table {
        width: 100%;
        border-collapse: collapse;
      }

      .log-table th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
      }

      .log-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .log-table tr:hover {
        background: #f5f5f5;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px 25px;
        border-radius: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #1db954;
        animation: blink 2s infinite;
      }

      .status-dot.disconnected {
        background: #ff4444;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      @media (max-width: 768px) {
        .chart-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }
      }
    </style>
  </head>
  <body>
    <div class="connection-status">
      <div class="status-dot" id="connection-dot"></div>
      <span id="connection-text">Connected</span>
    </div>

    <div class="container">
      <div class="header">
        <h1>üìä User Behavior Pattern Analysis</h1>
        <p>Gesture Usage Analytics & Statistics</p>
      </div>

      <div class="nav-buttons">
        <a href="dashboard.html" class="nav-btn">üè† Main Dashboard</a>
        <a href="#" class="nav-btn" onclick="refreshData()">üîÑ Refresh</a>
      </div>

      <!-- Summary Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Gestures</h3>
          <div class="stat-value" id="total-gestures">0</div>
        </div>
        <div class="stat-card">
          <h3>Most Used Gesture</h3>
          <div class="stat-value" id="most-used-gesture" style="font-size: 2em">
            -
          </div>
        </div>
        <div class="stat-card">
          <h3>Most Controlled Device</h3>
          <div class="stat-value" id="most-used-device" style="font-size: 2em">
            -
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-grid">
        <div class="chart-card">
          <h2>Gesture Usage Frequency</h2>
          <canvas id="gestureChart"></canvas>
        </div>

        <div class="chart-card">
          <h2>Device Usage Statistics</h2>
          <canvas id="deviceChart"></canvas>
        </div>

        <div class="chart-card">
          <h2>Hourly Usage Pattern</h2>
          <canvas id="hourlyChart"></canvas>
        </div>
      </div>

      <!-- Recent Activity Log -->
      <div class="log-section">
        <h2>Recent Activity Log</h2>
        <table class="log-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Gesture</th>
              <th>Device</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="log-body">
            <tr>
              <td colspan="4" style="text-align: center; color: #999">
                Loading data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Flask API URL
      const API_URL = "http://localhost:5000";

      let gestureChart, deviceChart, hourlyChart;

      // Gesture name mapping
      const GESTURE_NAMES = {
        FIST: "Fist (‚úä)",
        PALM: "Palm (üñê)",
        ONE_FINGER: "One Finger (üëÜ)",
        PEACE: "Peace (‚úåÔ∏è)",
        THREE_FINGERS: "Three Fingers (ü§ü)",
        FOUR_FINGERS: "Four Fingers (üññ)",
      };

      // Device name mapping
      const DEVICE_NAMES = {
        LIGHT: "Light üí°",
        DOOR: "Door üö™",
        MUSIC: "Music üéµ",
      };

      // Fetch analytics data
      async function fetchAnalytics() {
        try {
          const response = await fetch(`${API_URL}/api/analytics`);

          if (!response.ok) {
            throw new Error("API connection failed");
          }

          const data = await response.json();

          // Connection status
          document
            .getElementById("connection-dot")
            .classList.remove("disconnected");
          document.getElementById("connection-text").textContent = "Connected";

          // Update summary
          updateSummary(data);

          // Update charts
          updateGestureChart(data.gesture_frequency);
          updateDeviceChart(data.device_usage);
          updateHourlyChart(data.hourly_usage);

          // Update log table
          updateLogTable(data.recent_logs);
        } catch (error) {
          console.error("Error fetching analytics:", error);
          document
            .getElementById("connection-dot")
            .classList.add("disconnected");
          document.getElementById("connection-text").textContent =
            "Disconnected";
        }
      }

      // Update summary statistics
      function updateSummary(data) {
        document.getElementById("total-gestures").textContent =
          data.total_gestures;

        // Most used gesture
        const gestures = data.gesture_frequency;
        if (Object.keys(gestures).length > 0) {
          const mostUsed = Object.keys(gestures).reduce((a, b) =>
            gestures[a] > gestures[b] ? a : b
          );
          document.getElementById("most-used-gesture").textContent =
            GESTURE_NAMES[mostUsed] || mostUsed;
        }

        // Most controlled device
        const devices = data.device_usage;
        if (Object.keys(devices).length > 0) {
          const mostUsedDevice = Object.keys(devices).reduce((a, b) =>
            devices[a] > devices[b] ? a : b
          );
          document.getElementById("most-used-device").textContent =
            DEVICE_NAMES[mostUsedDevice] || mostUsedDevice;
        }
      }

      // Gesture chart
      function updateGestureChart(data) {
        const ctx = document.getElementById("gestureChart").getContext("2d");

        if (gestureChart) {
          gestureChart.destroy();
        }

        const labels = Object.keys(data).map((g) => GESTURE_NAMES[g] || g);
        const values = Object.values(data);

        gestureChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Usage Count",
                data: values,
                backgroundColor: [
                  "rgba(102, 126, 234, 0.8)",
                  "rgba(118, 75, 162, 0.8)",
                  "rgba(29, 185, 84, 0.8)",
                  "rgba(255, 215, 0, 0.8)",
                  "rgba(255, 99, 132, 0.8)",
                  "rgba(54, 162, 235, 0.8)",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // Device chart
      function updateDeviceChart(data) {
        const ctx = document.getElementById("deviceChart").getContext("2d");

        if (deviceChart) {
          deviceChart.destroy();
        }

        const labels = Object.keys(data).map((d) => DEVICE_NAMES[d] || d);
        const values = Object.values(data);

        deviceChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: [
                  "rgba(255, 215, 0, 0.8)",
                  "rgba(76, 175, 80, 0.8)",
                  "rgba(29, 185, 84, 0.8)",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // Hourly chart
      function updateHourlyChart(data) {
        const ctx = document.getElementById("hourlyChart").getContext("2d");

        if (hourlyChart) {
          hourlyChart.destroy();
        }

        // Prepare 0-23 hour data
        const hours = Array.from({ length: 24 }, (_, i) => i);
        const values = hours.map((h) => data[h] || 0);
        const labels = hours.map((h) => `${h}:00`);

        hourlyChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Usage Count",
                data: values,
                borderColor: "rgba(102, 126, 234, 1)",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // Update log table
      function updateLogTable(logs) {
        const tbody = document.getElementById("log-body");

        if (logs.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="text-align: center; color: #999;">No records yet</td></tr>';
          return;
        }

        tbody.innerHTML = logs
          .map(
            (log) => `
                <tr>
                    <td>${log.timestamp}</td>
                    <td>${GESTURE_NAMES[log.gesture] || log.gesture}</td>
                    <td>${DEVICE_NAMES[log.device] || log.device}</td>
                    <td>${log.action}</td>
                </tr>
            `
          )
          .join("");
      }

      // Refresh data
      function refreshData() {
        fetchAnalytics();
      }

      // Fetch data on page load
      fetchAnalytics();

      // Auto refresh every 5 seconds
      setInterval(fetchAnalytics, 5000);
    </script>
  </body>
</html>
